<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <title>Rapport Mensuel</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- html2pdf -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f6f8;
      margin: 0;
      padding: 0;
    }

    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #4f46e5;
      color: #fff;
      padding: 20px 40px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .admin-header .logo img {
      height: 40px;
    }

    .logout-btn {
      color: #fff;
      font-weight: bold;
      text-decoration: none;
    }

    .logout-btn i {
      margin-right: 8px;
    }
  </style>
</head>

<body class="bg-gray-100 text-gray-800 font-sans p-6">

<header class="admin-header">
  <div class="logo">
    <img src="/logo.png" alt="Logo" />
  </div>
  <a href="/logout" class="logout-btn"><i class="fas fa-sign-out-alt"></i>D√©connexion</a>
</header>

<div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-8" id="rapport-content">
  <!-- Statistiques -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8" id="statistiques-container">
    <!-- Rempli dynamiquement -->
  </div>

  <!-- Section Performance & Pr√©diction -->
  <div class="mb-8 bg-indigo-50 p-6 rounded shadow-md">
    <h3 class="text-xl font-bold text-center text-indigo-700 mb-4">Performance & Pr√©diction</h3>
    <div class="grid md:grid-cols-2 gap-4">
      <div class="bg-white p-4 rounded shadow text-center">
        <h4 class="text-lg font-semibold text-gray-700">Indice de Performance du Stock</h4>
        <p id="performanceScore" class="text-3xl font-bold text-indigo-600 mt-2">--%</p>
        <p class="text-sm text-gray-500 mt-1">Bas√© sur les articles g√©r√©s, taux de suppression et de renouvellement.</p>
      </div>
      <div class="bg-white p-4 rounded shadow text-center">
        <h4 class="text-lg font-semibold text-gray-700">Pr√©vision des commandes (mois prochain)</h4>
        <p id="predictionValue" class="text-3xl font-bold text-green-600 mt-2">--</p>
        <p class="text-sm text-gray-500 mt-1">Calcul estimatif bas√© sur les 6 derniers mois.</p>
      </div>
    </div>
  </div>

  <!-- Bouton Export PDF -->
  <div class="text-center mt-6">
    <button id="exportPdfBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
      üìÑ Exporter en PDF
    </button>
  </div>
</div>
<!-- Section Rapport Power BI -->
<div class="mb-8 bg-white p-6 rounded shadow-md">
  <h3 class="text-xl font-bold text-center text-indigo-700 mb-4">Analyse Power BI</h3>
  <div class="overflow-x-auto">
    <iframe title="gestionstock"
            width="100%"
            height="541"
            src="https://app.powerbi.com/reportEmbed?reportId=afeb348f-cc0c-41c7-be67-a26d46aedde3&autoAuth=true&ctid=2ec11419-847c-4e29-8815-7f5b2fed9339"
            frameborder="0"
            allowFullScreen="true"
            class="rounded-lg shadow-lg">
    </iframe>
  </div>
</div>


<script>
  // Charger les statistiques g√©n√©rales
  fetch('/api/rapport/stats')
          .then(res => res.json())
          .then(data => {
            document.getElementById('statistiques-container').innerHTML = `
        <div class="bg-blue-100 p-4 rounded shadow text-center">
          <h3 class="text-sm text-gray-600">Total articles</h3>
          <p class="text-2xl font-bold">${data.totalArticles}</p>
        </div>
        <div class="bg-green-100 p-4 rounded shadow text-center">
          <h3 class="text-sm text-gray-600">Valeur du stock</h3>
          <p class="text-2xl font-bold">${data.valeurStock} MAD</p>
        </div>
        <div class="bg-yellow-100 p-4 rounded shadow text-center">
          <h3 class="text-sm text-gray-600">Commandes du mois</h3>
          <p class="text-2xl font-bold">${data.totalCommandes}</p>
        </div>
      `;
          });

  // Calculer l'indice de performance
  function calculerIndicePerformance(evolution) {
    let totalAjoutes = 0;
    let totalSupprimes = 0;

    evolution.forEach(item => {
      totalAjoutes += item.ajoutes;
      totalSupprimes += item.supprimes;
    });

    const ratio = (totalAjoutes - totalSupprimes) / (totalAjoutes + 1); // +1 pour √©viter division par 0
    return Math.min(Math.max(Math.round(ratio * 100), 0), 100); // pourcentage entre 0 et 100
  }

  // Pr√©dire les commandes avec la moyenne mobile
  function predireCommandes(evolution) {
    const derniersMois = evolution.slice(-6);
    const somme = derniersMois.reduce((acc, item) => acc + item.commandes, 0);
    return Math.round(somme / derniersMois.length);
  }

  // Charger l'√©volution mensuelle
  fetch('/api/rapport/evolution')
          .then(res => res.json())
          .then(data => {
            console.log("√âvolution re√ßue :", data);

            const evolution = data;

            // Calcul de l'indice de performance
            const indice = calculerIndicePerformance(evolution);
            document.getElementById("performanceScore").innerText = indice + " %";

            // Pr√©vision des commandes
            if (evolution[0]?.commandes !== undefined) {
              const prediction = predireCommandes(evolution);
              document.getElementById("predictionValue").innerText = prediction;
            } else {
              document.getElementById("predictionValue").innerText = "N/A";
            }
          });


  // Exporter en PDF
  document.getElementById("exportPdfBtn").addEventListener("click", () => {
    const element = document.getElementById("rapport-content");
    html2pdf().from(element).save("rapport-mensuel.pdf");
  });
</script>

</body>

</html>
